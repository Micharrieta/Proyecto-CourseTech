<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Estad√≠sticas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
</head>

<body class="bg-gray-50 text-black dark:bg-gray-900 dark:text-white transition-colors duration-300">

  <section id="titulo-dash" class="px-[5%] py-6 md:py-8 lg:py-10 mx-auto">
    <div class="container mx-auto">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <h1
          class="py-2 bg-gradient-to-r from-sky-500 via-sky-600 to-sky-500 inline-block text-transparent bg-clip-text mb-5 text-4xl font-bold md:mb-6 md:text-5xl lg:text-6xl">
          Dashboard
        </h1>

        <div class="flex items-center gap-2">
          <button onclick="cerrarSesion()"
            class="group flex items-center justify-start w-11 h-11 bg-red-600 rounded-lg cursor-pointer relative overflow-hidden transition-all duration-200 shadow-lg hover:w-32 hover:rounded-lg active:translate-x-1 active:translate-y-1">
            <div
              class="flex items-center justify-center w-full transition-all duration-300 group-hover:justify-start group-hover:px-3">
              <svg class="w-4 h-4" viewBox="0 0 512 512" fill="white">
                <path
                  d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z">
                </path>
              </svg>
            </div>
            <div
              class="absolute right-5 transform translate-x-full opacity-0 text-white text-lg font-semibold transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100">
              Cerrar
            </div>
          </button>

          <button id="toggleDark" class="w-11 h-11 p-2 rounded-lg shadow-lg bg-gray-200 dark:bg-gray-700">
            üåì
          </button>

          <button onclick="volverIncio()"
            class="w-11 h-11 text-lg p-2 rounded-lg shadow-lg bg-gray-300 dark:bg-gray-700">
            üè†
          </button>
        </div>
      </div>
      <p class="md:text-md">
        Desde aqu√≠ podr√°s ver todos las estadisticas relacionadas a la plataforma.
      </p>
    </div>
  </section>


  <section id="cont-inicio" class="px-[5%] pb-[5%]">
    <div class="container mx-auto">

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10" id="tarjetas-estadisticas"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-10">
        <div class="bg-white p-4 rounded-lg shadow dark:bg-gray-800 ">
          <h3 class="text-xl font-semibold text-sky-600 text-center mb-4 dark:text-sky-400">Distribuci√≥n de usuarios por
            rol</h3>
          <canvas class="max-h-[600px] mx-auto" id="graficoRoles"></canvas>
        </div>
        <div class="bg-white p-4 rounded-lg shadow dark:bg-gray-800">
          <h3 class="text-xl font-semibold text-sky-600 text-center mb-4 dark:text-sky-400">Preguntas por evaluaci√≥n
          </h3>
          <canvas class="" id="graficoPreguntas"></canvas>
        </div>
      </div>
  </section>

</body>

<script>
  const token = localStorage.getItem('token');

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('http://localhost:5000/api/admin/estadisticas', {
        headers: {
          Authorization: 'Bearer ' + token
        }
      });
      const data = await res.json();

      mostrarTarjetas(data);
      mostrarGrafico(data.preguntasPorEvaluacion);
      mostrarGraficoRoles(data.usuariosPorRol);
    } catch (err) {
      console.error('‚ùå Error al cargar estad√≠sticas:', err);
      alert('No se pudieron cargar las estad√≠sticas');
    }
  });

  function mostrarTarjetas(data) {
    const contenedor = document.getElementById('tarjetas-estadisticas');
    contenedor.innerHTML = '';

    const estadisticas = [
      { titulo: 'Usuarios registrados', valor: data.totalUsuarios },
      { titulo: 'Cursos disponibles', valor: data.totalCursos },
      { titulo: 'Evaluaciones', valor: data.totalEvaluaciones },
      { titulo: 'Total preguntas', valor: data.totalPreguntas },
      { titulo: 'Evaluaciones respondidas', valor: data.totalRespuestas },
      { titulo: 'Usuarios que completaron evaluaciones', valor: data.usuariosRespondieron },
      { titulo: 'Promedio de puntajes entre todas las evaluaciones', valor: data.promedioPuntajes + '%' },
      { titulo: 'Evaluaci√≥n m√°s respondida', valor: data.evaluacionMasRespondida },
      { titulo: 'Usuario m√°s activo', valor: data.usuarioMasActivo }
    ];

    estadisticas.forEach(est => {
      const div = document.createElement('div');
      div.className = 'bg-white p-5 rounded-lg shadow text-center dark:bg-gray-800';
      div.innerHTML = `
          <h3 class="text-lg text-gray-700 dark:text-gray-200 font-medium">${est.titulo}</h3>
          <p class="text-3xl font-bold text-sky-600 dark:text-sky-400 mt-2">${est.valor}</p>
        `;
      contenedor.appendChild(div);
    });
  }

  function mostrarGrafico(preguntasPorEvaluacion) {
  const ctx = document.getElementById('graficoPreguntas').getContext('2d');
  const isDarkMode = document.documentElement.classList.contains('dark');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: preguntasPorEvaluacion.map(e => e.titulo),
      datasets: [{
        label: 'Preguntas por evaluaci√≥n',
        data: preguntasPorEvaluacion.map(e => e.totalPreguntas),
        backgroundColor: ['#0ea5e9', '#FFBF00', '#22c55e']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false,
          labels: {
            color: isDarkMode ? '#90a1b9' : '#90a1b8' // color del texto de la leyenda
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: isDarkMode ? '#90a1b9' : '#90a1b9', // color etiquetas X
            font: {
              size: 9
            }
          },
          grid: {
            color: isDarkMode ? '#90a1b9' : '#90a1b9' // l√≠neas verticales del grid
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            color: isDarkMode ? '#90a1b9' : '#90a1b9' // color etiquetas Y
          },
          grid: {
            color: isDarkMode ? '#90a1b9' : '#90a1b9' // l√≠neas horizontales del grid
          }
        }
      }
    }
  });
}



  function mostrarGraficoRoles(usuariosPorRol) {
    const ctx = document.getElementById('graficoRoles').getContext('2d');
    const isDarkMode = document.documentElement.classList.contains('dark');


     new Chart(ctx, {
      type: 'pie',
      data: {
        labels: usuariosPorRol.map(r => r.rol),
        datasets: [{
          label: 'Usuarios por rol',
          data: usuariosPorRol.map(r => r.total),
          backgroundColor: ['#0ea5e9', '#FFBF00', '#22c55e', '#facc15'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: isDarkMode ? '#90a1b9' : '#90a1b9' 
            }
          }
        }
      }
    });
  }


  function cerrarSesion() {
    localStorage.removeItem('token');
    window.location.href = '../index.html';
  }

  const toggle = document.getElementById('toggleDark');
  const html = document.documentElement;

  toggle.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
  });

  // Establecer el tema al cargar
  if (
    localStorage.theme === 'dark' ||
    (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
  ) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }

  function volverIncio() {
    window.location.href = '../Pags-Admin/PanelAdmin.html';
  }

</script>

</html>