<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <title>Evaluaci√≥n 2</title>
</head>

<body class="bg-gray-50 text-black dark:bg-gray-900 dark:text-white transition-colors duration-300">
  <section id="enc-eva1" class="px-[5%] py-8 md:py-10 lg:py-12">
    <div class="container mx-auto">
      <div class="flex justify-between items-center flex-wrap gap-4">

        <h1
          class="mb-5 py-2 bg-gradient-to-r from-sky-500 via-sky-600 to-sky-500 inline-block text-transparent bg-clip-text text-6xl font-bold md:mb-6 md:text-9xl lg:text-7xl">
          Evaluaci√≥n 2
        </h1>

        <div class="flex items-center gap-2">


          <button onclick="cerrarSesion()"
            class="group flex items-center justify-start w-11 h-11 bg-red-600 rounded-lg cursor-pointer relative overflow-hidden transition-all duration-200 shadow-lg hover:w-32 hover:rounded-lg active:translate-x-1 active:translate-y-1">
            <div
              class="flex items-center justify-center w-full transition-all duration-300 group-hover:justify-start group-hover:px-3">
              <svg class="w-4 h-4" viewBox="0 0 512 512" fill="white">
                <path
                  d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z">
                </path>
              </svg>
            </div>
            <div
              class="absolute right-5 transform translate-x-full opacity-0 text-white text-lg font-semibold transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100">
              Cerrar
            </div>
          </button>

          <button id="toggleDark" class="w-11 h-11 p-2 rounded-lg shadow-lg bg-gray-300 dark:bg-gray-700">
            üåì
          </button>

          <button onclick="volverIncio()"
            class="w-11 h-11 text-lg p-2 rounded-lg shadow-lg bg-gray-300 dark:bg-gray-700">
            üè†
          </button>

        </div>

      </div>
    </div>
  </section>

  <section id="evaluacion" class="px-[5%] pb-16">
    <div class="container mx-auto">
      <form id="form-evaluacion">
        <div id="preguntas" class="mx-auto">

        </div>

        <div id="resultado" class="mt-6 text-2xl font-bold text-center text-green-600 hidden">
        </div>

        <div class="flex">
          <button id="enviar" type="submit"
            class="mt-4 mr-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
            Enviar respuestas
          </button>
        </div>

      </form>

      <a href="tests.html">
        <button
          class="mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          Salir
        </button>
      </a>
    </div>
  </section>

</body>

<script>
  const idEvaluacion = 2; // Cambia seg√∫n la evaluaci√≥n
  const token = localStorage.getItem('token');

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch(`http://localhost:5000/api/evaluaciones/${idEvaluacion}`, {
        headers: {
          Authorization: 'Bearer ' + token
        }
      });

      const preguntas = await res.json();
      const contenedor = document.getElementById('preguntas');

      preguntas.forEach((pregunta, index) => {
        const tarjeta = document.createElement('div');
        tarjeta.className = 'bg-white p-6 shadow-md rounded-xl mb-6 dark:bg-gray-800';

        const titulo = document.createElement('h3');
        titulo.className = 'text-lg font-semibold text-sky-600 mb-3 dark:text-sky-400';
        titulo.textContent = `Pregunta ${index + 1}`;

        const enunciado = document.createElement('p');
        enunciado.className = 'mb-4 text-gray-900 font-medium dark:text-white';
        enunciado.textContent = pregunta.texto;

        tarjeta.appendChild(titulo);
        tarjeta.appendChild(enunciado);

        // Opciones una por una
        pregunta.opciones.forEach(op => {
          const label = document.createElement('label');
          label.className = 'text-gray-800 dark:text-gray-200';
          label.textContent = op.texto; // ‚Üê esto escapa las etiquetas autom√°ticamente

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `pregunta-${pregunta.id_pregunta}`;
          input.value = op.id_opcion;
          input.className = 'text-sky-500';

          const contenedor = document.createElement('div');
          contenedor.className = 'opcion-container flex items-center gap-2 my-2';
          contenedor.appendChild(input);
          contenedor.appendChild(label);

          tarjeta.appendChild(contenedor);
        });

        contenedor.appendChild(tarjeta);
      });

    } catch (err) {
      console.error('‚ùå Error al cargar preguntas:', err);
      alert('No se pudieron cargar las preguntas');
    }
  });

  document.getElementById('form-evaluacion').addEventListener('submit', async e => {
    e.preventDefault();

    const respuestas = [];
    const preguntasInputs = document.querySelectorAll('[name^="pregunta-"]');
    const preguntasUnicas = [...new Set([...preguntasInputs].map(p => p.name))];

    // Verificar que todas est√©n respondidas
    const faltantes = preguntasUnicas.filter(name => !document.querySelector(`[name="${name}"]:checked`));
    if (faltantes.length > 0) {
      alert('‚ö†Ô∏è Debes responder todas las preguntas antes de enviar.');
      return;
    }

    preguntasUnicas.forEach(name => {
      const seleccionada = document.querySelector(`[name="${name}"]:checked`);
      const id_pregunta = parseInt(name.split('-')[1]);
      const id_opcion = parseInt(seleccionada.value);
      respuestas.push({ id_pregunta, id_opcion });
    });

    try {
      const res = await fetch('http://localhost:5000/api/evaluaciones/responder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: 'Bearer ' + token
        },
        body: JSON.stringify({
          id_evaluacion: idEvaluacion,
          respuestas
        })
      });

      const data = await res.json();

      if (res.ok) {
        // Mostrar puntaje con estilo
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = `Tu puntaje fue: ${data.puntaje.toFixed(2)}%`;
        resultadoDiv.className = 'text-sky-500 text-xl font-semibold my-6'; // Aplicar estilo directamente
        resultadoDiv.classList.remove('hidden');

        // Volver a cargar preguntas con info de respuestas correctas
        const res2 = await fetch(`http://localhost:5000/api/evaluaciones/${idEvaluacion}`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        const preguntasCompletas = await res2.json();

        preguntasCompletas.forEach(pregunta => {
          pregunta.opciones.forEach(op => {
            const input = document.querySelector(`input[name="pregunta-${pregunta.id_pregunta}"][value="${op.id_opcion}"]`);
            if (input) {
              input.disabled = true;

              const labelContainer = input.parentElement;
              if (op.es_correcta) {
                // Sombrea la opci√≥n correcta
                labelContainer.classList.add('bg-green-100', 'border', 'border-green-500', 'rounded', 'px-2', 'py-1');
              }
            }
          });
        });

        // Deshabilitar bot√≥n
        document.getElementById('enviar').disabled = true;

      } else {
        alert('‚ùå Error: ' + data.error);
      }

    } catch (err) {
      console.error('‚ùå Error al enviar respuestas:', err);
      alert('Error al enviar las respuestas');
    }
  });

  function cerrarSesion() {
    localStorage.removeItem('token');
    window.location.href = 'index.html';
  }

  const toggle = document.getElementById('toggleDark');
  const html = document.documentElement;

  toggle.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
  });

  // Establecer el tema al cargar
  if (
    localStorage.theme === 'dark' ||
    (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
  ) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }

  function volverIncio() {
    window.location.href = 'inicio.html';
  }
</script>



</html>